<!DOCTYPE html>
<!--
  Questionnaires Battery Example

  This example demonstrates the questionnaires task with full resumption support.

  USAGE:
  1. Basic test (default wk0 session):
     http://localhost:8000/examples/questionnaires.html

  2. Test screening session:
     http://localhost:8000/examples/questionnaires.html?session=screening

  3. Test wk0 session:
     http://localhost:8000/examples/questionnaires.html?session=wk0

  5. Test wk24 session:
     http://localhost:8000/examples/questionnaires.html?session=wk24

  6. Test resumption (after starting PHQ):
     http://localhost:8000/examples/questionnaires.html?session=wk0&state=PHQ_start

  SESSION-SPECIFIC QUESTIONNAIRES:
  - screening: PHQ, WSAS, ICECAP, BFI (4 questionnaires)
  - wk0, wk2, wk4, wk28: PHQ, GAD, PVSS, BADS, hopelessness, RRS_brooding, PERS_negAct (7 questionnaires; default list)
  - wk24: PHQ, GAD, WSAS, ICECAP, PVSS, BADS, hopelessness, RRS_brooding, PERS_negAct (9 questionnaires)

  AVAILABLE QUESTIONNAIRES:
  PHQ, GAD, WSAS, ICECAP, BFI, PVSS, BADS, hopelessness, RRS_brooding, PERS_negAct
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaires Battery</title>

    <script type="importmap">
        {
            "imports": {
                "@utils/": "../core/utils/",
                "@jspsych/": "../core/jspsych/",
                "@tasks/": "../tasks/",
                "@api/": "../api/",
                "@images/": "../assets/images/"
            }
        }
    </script>

    <!-- jsPsych Core Files -->
    <script src="../core/jspsych/jspsych.js"></script>
    <script src="../core/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="../core/jspsych/plugin-html-button-response.js"></script>
    <script src="../core/jspsych/plugin-instructions.js"></script>
    <script src="../core/jspsych/plugin-preload.js"></script>
    <script src="../core/jspsych/plugin-call-function.js"></script>
    <script src="../core/jspsych/plugin-fullscreen.js"></script>
    <script src="../core/jspsych/plugin-survey-multi-choice.js"></script>
    <script src="../core/jspsych/plugin-survey-likert.js"></script>

    <!-- Custom questionnaire plugin -->
    <script src="../tasks/questionnaires/plugin-survey-template.js"></script>

    <!-- Core utilities -->
    <script type="module" src="../core/utils/index.js"></script>

    <!-- CSS Styles -->
    <link href="/core/jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="/tasks/questionnaires/styles.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #display_element {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .instructions p {
            width: 700px;
            text-align: left;
            margin: 1em 0;
        }
    </style>
</head>
<body>
    <div id="display_element"></div>

    <script type="module">
        // Import task registry functions
        import { createTaskTimeline, getTaskInfo } from '../api/index.js';
        import { enterExperiment } from '../core/utils/index.js';

        // Get parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        window.participantID = urlParams.get('participant_id') || 'test_participant';
        window.simulating = window.participantID.includes("simulate") || false;
        const session = urlParams.get('session') || 'wk0'; // Default to wk0 session

        // Initialize jsPsych
        window.jsPsych = initJsPsych({
            display_element: 'display_element',
            on_finish: function(data) {
                // Display results
                jsPsych.getDisplayElement().innerHTML = '<p>Questionnaires complete. Thank you for participating!</p>';
                console.log('Experiment data:', data.values());

                // Show response data in console
                const responses = data.filterCustom(function(trial) {
                    const trialphase = trial.trialphase
                    return trialphase !== undefined && trialphase.match(/PHQ|GAD|PVSS|BADS|hopelessness|RRS_brooding|PERS_negAct|WSAS|ICECAP|BFI/)
                });
                console.log('Questionnaire responses:', responses.values());
            }
        });


        // Function to run the experiment
        async function runExperiment() {
            try {
                console.log('Starting questionnaires battery...');

                // Get task information
                const taskInfo = getTaskInfo('questionnaires');
                console.log('Task info:', taskInfo);
                console.log('Session:', session);

                // Use session-specific questionnaire list
                // The session parameter is passed to createTaskTimeline and the task will
                // automatically select the appropriate questionnaire list from sessionQuestionnaires
                const timeline = await createTaskTimeline('questionnaires', {
                    session: session
                });

                // Alternative: Override with custom list (ignores session mapping)
                // const timeline = await createTaskTimeline('questionnaires', {
                //     questionnaire_list: ["PHQ", "GAD"]
                // });

                console.log('Timeline created:', timeline);

                const exitFullscreen = {
                    type: jsPsychFullscreen,
                    fullscreen_mode: false
                };

                // Create the complete timeline
                const fullTimeline = [
                    enterExperiment,
                    ...timeline,
                    exitFullscreen
                ];

                // Run the experiment
                if (window.simulating) {
                    console.log('Simulating experiment run...');

                    // Simulation options
                    let simulation_options = {
                        default: {
                            data: {
                                rt: 200,
                                speed_up: true,
                                speed_up_factor: 10,
                            }
                        }
                    }

                    await jsPsych.simulate(fullTimeline, "visual", simulation_options);
                } else {
                    console.log('Running experiment...');
                    await jsPsych.run(fullTimeline);
                }

            } catch (error) {
                console.error('Error running experiment:', error);
                jsPsych.getDisplayElement().innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>Error Loading Questionnaires</h2>
                        <p>There was an error loading the questionnaires:</p>
                        <p><strong>${error.message}</strong></p>
                        <p>Please check the console for more details.</p>
                    </div>
                `;
            }
        }

        // Start the experiment when the page loads
        window.addEventListener('load', runExperiment);
    </script>
</body>
</html>
