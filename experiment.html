<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study</title>

    <script type="importmap">
        {
            "imports": {
                "@utils/": "./core/utils/",
                "@jspsych/": "./core/jspsych/",
                "@tasks/": "./tasks/",
                "@api/": "./api/",
                "@images/": "./assets/images/"
            }
        }
    </script>

    <!-- jsPsych Core Files -->
    <script src="core/jspsych/jspsych.js"></script>
    <script src="core/jspsych/plugin-html-keyboard-response.js"></script>
    <script src="core/jspsych/plugin-html-button-response.js"></script>
    <script src="core/jspsych/plugin-instructions.js"></script>
    <script src="core/jspsych/plugin-preload.js"></script>
    <script src="core/jspsych/plugin-call-function.js"></script>
    <script src="core/jspsych/plugin-fullscreen.js"></script>
    <script src="core/jspsych/plugin-survey-multi-choice.js"></script>
    <script src="core/jspsych/plugin-survey-likert.js"></script>
    <script src="core/jspsych/plugin-video-button-response.js"></script>


    <!-- Task-specific files -->
    <script src="tasks/card-choosing/plugin-card-choosing.js"></script>
    <script src="tasks/control/plugins/plugin-explore-ship.js"></script>
    <script src="tasks/control/plugins/plugin-explore-ship-feedback.js"></script>
    <script src="tasks/control/plugins/plugin-predict-home-base.js"></script>
    <script src="tasks/control/plugins/plugin-reward-ship.js"></script>
    <script src="tasks/control/plugins/plugin-reward-prompt.js"></script>
    <script src="tasks/reversal/plugin-reversal.js"></script>
    <script src="tasks/open-text/plugin-open-text.js"></script>
    <script src="tasks/questionnaires/plugin-survey-template.js"></script>
    <script src="tasks/questionnaires/plugin-survey-demo.js"></script>


    <!-- Core utilities -->
    <script type="module" src="core/utils/index.js"></script>

    <!-- CSS Styles -->
    <link href="core/jspsych/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        .jsPsychDE {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .instructions p {
            width: 700px;
            text-align: left;
        }

        .instructions td {
            padding-left: 20px;
            padding-right: 20px;
        }

        #jspsych-video-button-response-stimulus {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.10);
            max-width: 100%;
            display: block;
            margin: 10px auto;
        }
    </style>
</head>

<body>
    <div id='display_element' class='jsPsychDE'></div>

    <script type="module">
        // Import task registry functions
        import { createModuleTimeline, getModuleInfo } from '@api/index.js';
        import { enterExperiment } from '@utils/index.js';

        // Set context
        window.context = "prolific";

        // Get parameters from URL
        window.participantID = new URLSearchParams(window.location.search).get('PROLIFIC_PID') || '';
        window.simulating = window.participantID.includes("simulate") || false;
        console.log(window.simulating);

        // Initialize jsPsych
        window.jsPsych = initJsPsych({
            display_element: 'display_element'
        });

        // Configurations
        window.session = new URLSearchParams(window.location.search).get('session') || 'wk0';
        window.module = new URLSearchParams(window.location.search).get('module') ;

        const settings = {
            sequence: window.session,
            session: window.session
        };

        // Function to run the experiment
        async function runExperiment() {
            try {
                // Get module information
                const moduleInfo = getModuleInfo(module);
                console.log('Module info:', moduleInfo);

                // Create the timeline
                const timeline = await createModuleTimeline(module, settings);
                console.log('Timeline created:', timeline);

                const exitFullscreen = {
                    type: jsPsychFullscreen,
                    fullscreen_mode: false
                };

                // Create the complete timeline
                const fullTimeline = [
                    enterExperiment,
                    ...timeline,
                    exitFullscreen
                ];

                // Run the experiment
                if (window.simulating) {
                    console.log('Simulating experiment run...');

                    // Simulation options
                    let simulation_options = {
                        default: {
                            speed_up: true,
                            speed_up_factor: 10,
                            data: {
                                rt: 200
                            }
                        }
                    }

                    await jsPsych.simulate(fullTimeline, "visual", simulation_options);
                } else {
                    console.log('Running experiment...');
                    await jsPsych.run(fullTimeline);
                }

            } catch (error) {
                console.error('Error running experiment:', error);
                jsPsych.getDisplayElement().innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>Error Loading Experiment</h2>
                        <p>There was an error loading the card choosing task:</p>
                        <p><strong>${error.message}</strong></p>
                        <p>Please check the console for more details.</p>
                    </div>
                `;
            }
        }

        // Start the experiment when the page loads
        window.addEventListener('load', runExperiment);
    </script>
</body>

</html>